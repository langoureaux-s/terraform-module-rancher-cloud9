version: '2'
volumes:
  cloud9-workspace:
    driver: rancher-nfs
services:
  cloud9:
    image: webcenter/cloud9-workspace:latest
    environment:
      - DOCKER_HOST=docker:2375
      - http_proxy=${proxy}
      - https_proxy=${proxy}
      - no_proxy=localhost, 127.0.0.1, docker, rancher-metadata, .hm.dm.ad
      - ARM_SUBSCRIPTION_ID=${arm_subscription_id}
      - ARM_CLIENT_ID=${arm_client_id}
      - ARM_CLIENT_SECRET=${arm_client_secret}
      - ARM_TENANT_ID=${arm_tenant_id}
      - ARM_ACCESS_KEY=${arm_access_key}
      - RANCHER_ACCESS_KEY=${rancher_access_key}
      - RANCHER_SECRET_KEY=${rancher_secret_key}
      - CONSUL_HTTP_TOKEN=${consul_http_token}
    stdin_open: true
    volumes:
    - cloud9-workspace:/workspace
    - /etc/pki/ca-trust/source/anchors:/usr/local/share/ca-certificates:ro
    tty: true
    command: 
    - --listen 0.0.0.0 --port 8080 -w /workspace --collab true --setting-path /workspace/.c9 --auth "${username}:${password}"
    labels:
      io.rancher.container.pull_image: always
      io.rancher.sidekicks: docker
  docker:
    privileged: true
    image: index.docker.io/docker:17-dind
    environment:
      - NO_PROXY=localhost, 127.0.0.1, .hm.dm.ad
      - HTTP_PROXY=${proxy}
      - HTTPS_PROXY=${proxy}
    entrypoint:
    - /bin/sh
    - -c
    stdin_open: true
    network_mode: bridge
    volumes:
    - cloud9-workspace:/workspace
    - /etc/pki/ca-trust/source/anchors:/usr/local/share/ca-certificates:ro
    tty: true
    command:
    - update-ca-certificates && dockerd-entrypoint.sh --storage-driver=overlay2  --storage-opt overlay2.override_kernel_check=true
    labels:
      io.rancher.container.pull_image: always